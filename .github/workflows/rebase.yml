name: Rebase Pull Requests
on:
    push:
        branches: [main]
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'PR number to rebase (leave empty for all open PRs)'
                required: false
                type: string

permissions:
    contents: write
    pull-requests: write

jobs:
    auto-rebase:
        name: Rebase PRs
        runs-on: ubuntu-latest
        timeout-minutes: 15
        steps:
            - name: Checkout main
              uses: actions/checkout@v6
              with:
                  ref: main
                  fetch-depth: 0

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Update PR branches
              if: github.event_name == 'push' && github.ref == 'refs/heads/main'
              run: |
                  set +e  # Don't exit on errors - we want to process all PRs
                  echo "Updating all PRs with latest main (including drafts and failing CI)..."

                  # Get all open PRs that need updating (including drafts and failing CI)
                  gh pr list --state open --json number,isDraft,mergeStateStatus \
                    --jq '.[] | select(.mergeStateStatus == "DIRTY" or .mergeStateStatus == "UNSTABLE") | .number' | \
                  while read -r pr; do
                    echo "----------------------------------------"
                    echo "Updating PR #$pr with latest main..."

                    # Use GitHub API to update the branch with main
                    if gh api -X PUT "repos/${{ github.repository }}/pulls/$pr/update-branch" \
                        -H "Accept: application/vnd.github+json" \
                        -f expected_head_sha="$(gh pr view $pr --json headRefOid -q '.headRefOid')" 2>&1; then
                      echo "✓ Successfully updated PR #$pr"
                    else
                      echo "✗ Failed to update PR #$pr (may have conflicts or be from a fork)"
                    fi
                  done
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Update specific PR branch
              if: github.event_name == 'workflow_dispatch' && inputs.pr_number != ''
              run: |
                  echo "Updating PR #${{ inputs.pr_number }} with latest main..."

                  # Use GitHub API to update the branch
                  gh api -X PUT "repos/${{ github.repository }}/pulls/${{ inputs.pr_number }}/update-branch" \
                      -H "Accept: application/vnd.github+json" \
                      -f expected_head_sha="$(gh pr view ${{ inputs.pr_number }} --json headRefOid -q '.headRefOid')"

                  echo "✓ Successfully updated PR #${{ inputs.pr_number }}"
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
