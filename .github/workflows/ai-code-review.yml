name: AI-Powered Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    # Only run on significant changes
    paths:
    - 'src/**/*.py'
    - '**.py'

permissions:
  contents: read
  pull-requests: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    # Make this job optional - don't block PRs if AI is not configured
    continue-on-error: true

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check AI capabilities
      id: ai-check
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        if [[ -n "$ANTHROPIC_API_KEY" ]]; then
          echo "ai_provider=anthropic" >> $GITHUB_OUTPUT
          echo "ai_available=true" >> $GITHUB_OUTPUT
        elif [[ -n "$OPENAI_API_KEY" ]]; then
          echo "ai_provider=openai" >> $GITHUB_OUTPUT
          echo "ai_available=true" >> $GITHUB_OUTPUT
        else
          echo "ai_available=false" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è AI code review not available - no API keys configured"
          echo "To enable:"
          echo "1. Add ANTHROPIC_API_KEY or OPENAI_API_KEY to repository secrets"
          echo "2. AI will provide security, performance, and best practice analysis"
          exit 0
        fi

    - name: Get changed files
      if: steps.ai-check.outputs.ai_available == 'true'
      id: changed-files
      run: |
        # Get Python files changed in this PR
        git fetch origin main:main
        CHANGED_FILES=$(git diff --name-only main...HEAD -- '*.py' 'src/**/*.py' | head -10)
        echo "files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

        # Get the actual diff content
        git diff main...HEAD -- '*.py' 'src/**/*.py' > code_changes.diff

        # Check if diff is reasonable size for AI analysis
        DIFF_SIZE=$(wc -l < code_changes.diff)
        if [[ $DIFF_SIZE -gt 500 ]]; then
          echo "Large diff detected ($DIFF_SIZE lines) - truncating for AI analysis"
          head -500 code_changes.diff > code_changes_truncated.diff
          mv code_changes_truncated.diff code_changes.diff
        fi

    - name: Multi-agent AI review
      if: steps.ai-check.outputs.ai_available == 'true'
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AI_PROVIDER: ${{ steps.ai-check.outputs.ai_provider }}
      run: |
        mkdir -p reviews

        # Security-focused review
        echo "üîí Performing security analysis..."
        if [[ "$AI_PROVIDER" == "anthropic" ]]; then
          SECURITY_REVIEW=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-3-haiku-20240307",
              "max_tokens": 1000,
              "system": "You are a cybersecurity expert reviewing Python code. Focus on: SQL injection, XSS, authentication issues, data validation, secrets exposure, and insecure dependencies. Be specific and actionable.",
              "messages": [
                {
                  "role": "user",
                  "content": "Review this code for security vulnerabilities:\n\n'"$(cat code_changes.diff | sed 's/"/\\"/g' | head -200)"'"
                }
              ]
            }' | jq -r '.content[0].text' 2>/dev/null || echo "Security analysis failed")
        else
          SECURITY_REVIEW="OpenAI security review not implemented yet"
        fi
        echo "$SECURITY_REVIEW" > reviews/security.md

        # Performance-focused review
        echo "‚ö° Performing performance analysis..."
        if [[ "$AI_PROVIDER" == "anthropic" ]]; then
          PERFORMANCE_REVIEW=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-3-haiku-20240307",
              "max_tokens": 1000,
              "system": "You are a performance optimization expert for Python. Focus on: algorithmic complexity, memory usage, database query efficiency, caching opportunities, and scalability issues.",
              "messages": [
                {
                  "role": "user",
                  "content": "Review this code for performance issues:\n\n'"$(cat code_changes.diff | sed 's/"/\\"/g' | head -200)"'"
                }
              ]
            }' | jq -r '.content[0].text' 2>/dev/null || echo "Performance analysis failed")
        else
          PERFORMANCE_REVIEW="OpenAI performance review not implemented yet"
        fi
        echo "$PERFORMANCE_REVIEW" > reviews/performance.md

        # Best practices review
        echo "‚ú® Performing best practices analysis..."
        if [[ "$AI_PROVIDER" == "anthropic" ]]; then
          BEST_PRACTICES_REVIEW=$(curl -s -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d '{
              "model": "claude-3-haiku-20240307",
              "max_tokens": 1000,
              "system": "You are a Python code quality expert. Focus on: PEP 8 compliance, error handling, type hints, documentation, testability, and maintainability. Be constructive.",
              "messages": [
                {
                  "role": "user",
                  "content": "Review this code for best practices and maintainability:\n\n'"$(cat code_changes.diff | sed 's/"/\\"/g' | head -200)"'"
                }
              ]
            }' | jq -r '.content[0].text' 2>/dev/null || echo "Best practices analysis failed")
        else
          BEST_PRACTICES_REVIEW="OpenAI best practices review not implemented yet"
        fi
        echo "$BEST_PRACTICES_REVIEW" > reviews/best-practices.md

    - name: Post AI review comment
      if: steps.ai-check.outputs.ai_available == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');

          // Read review results
          const securityReview = fs.readFileSync('reviews/security.md', 'utf8').trim();
          const performanceReview = fs.readFileSync('reviews/performance.md', 'utf8').trim();
          const bestPracticesReview = fs.readFileSync('reviews/best-practices.md', 'utf8').trim();

          // Create comprehensive review comment
          const reviewComment = `## ü§ñ AI-Powered Code Review

          *Powered by ${process.env.AI_PROVIDER === 'anthropic' ? 'Claude AI' : 'OpenAI'}*

          ### üîí Security Analysis
          ${securityReview}

          ### ‚ö° Performance Analysis
          ${performanceReview}

          ### ‚ú® Best Practices Review
          ${bestPracticesReview}

          ---

          **Note**: This is an AI-generated analysis. Please review recommendations carefully and validate before implementing changes.

          **Feedback**: If this review is helpful or has issues, please react to this comment to help improve the AI analysis.`;

          // Check for existing AI review comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const existingReview = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('AI-Powered Code Review')
          );

          if (existingReview) {
            // Update existing review
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingReview.id,
              body: reviewComment
            });
            console.log('Updated existing AI review comment');
          } else {
            // Create new review
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: reviewComment
            });
            console.log('Created new AI review comment');
          }

    - name: Upload review artifacts
      if: steps.ai-check.outputs.ai_available == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ai-code-review-${{ github.event.pull_request.number }}
        path: |
          reviews/
          code_changes.diff
        retention-days: 30

  cost-tracking:
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Track AI usage
      uses: actions/github-script@v7
      with:
        script: |
          // Simple cost tracking
          const date = new Date().toISOString().split('T')[0];
          console.log(`AI Code Review executed on ${date} for PR #${context.issue.number}`);

          // Could be extended to track actual API costs
          // Store usage data in repository variables or external service
