name: Documentation Validation

on:
  pull_request:
    paths:
    - 'src/bolster/**'
    - 'docs/**'
    - 'README.md'
  push:
    branches: [main]
    paths:
    - 'src/bolster/**'
    - 'docs/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python and uv
      uses: astral-sh/setup-uv@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: uv sync --dev

    - name: Check for undocumented functions
      id: doc-check
      run: |
        echo "# Documentation Completeness Report" > doc_report.md
        echo "" >> doc_report.md

        # Find all public functions/classes in data source modules
        echo "## New or Modified Data Source Functions" >> doc_report.md

        # Get changed Python files
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD -- 'src/bolster/data_sources/*.py' 'src/bolster/data_sources/**/*.py')
        else
          CHANGED_FILES=$(find src/bolster/data_sources -name '*.py')
        fi

        echo "Checking files: $CHANGED_FILES"

        MISSING_DOCS=()
        GOOD_DOCS=()

        for file in $CHANGED_FILES; do
          if [[ -f "$file" ]]; then
            echo "### $file" >> doc_report.md

            # Extract function definitions
            FUNCTIONS=$(grep -n "^def " "$file" | grep -v "__" | head -10)

            while IFS= read -r line; do
              if [[ -n "$line" ]]; then
                FUNC_NAME=$(echo "$line" | sed 's/.*def \([^(]*\).*/\1/')
                LINE_NUM=$(echo "$line" | cut -d: -f1)

                # Check if function has docstring
                DOCSTRING_CHECK=$(sed -n "${LINE_NUM},/^def \|^class \|^$/p" "$file" | grep -E '^\s*"""' | head -1)

                if [[ -z "$DOCSTRING_CHECK" ]]; then
                  echo "- âŒ \`$FUNC_NAME\` (line $LINE_NUM) - **Missing docstring**" >> doc_report.md
                  MISSING_DOCS+=("$file:$FUNC_NAME")
                else
                  echo "- âœ… \`$FUNC_NAME\` (line $LINE_NUM) - Documented" >> doc_report.md
                  GOOD_DOCS+=("$file:$FUNC_NAME")
                fi
              fi
            done <<< "$FUNCTIONS"

            echo "" >> doc_report.md
          fi
        done

        # Summary
        echo "## Summary" >> doc_report.md
        echo "- âœ… Well documented: ${#GOOD_DOCS[@]} functions" >> doc_report.md
        echo "- âŒ Missing documentation: ${#MISSING_DOCS[@]} functions" >> doc_report.md
        echo "" >> doc_report.md

        if [[ ${#MISSING_DOCS[@]} -gt 0 ]]; then
          echo "## Required Actions" >> doc_report.md
          echo "The following functions need docstrings with Args, Returns, and Example sections:" >> doc_report.md
          for item in "${MISSING_DOCS[@]}"; do
            echo "- $item" >> doc_report.md
          done
          echo "DOC_ISSUES=true" >> $GITHUB_ENV
        else
          echo "DOC_ISSUES=false" >> $GITHUB_ENV
        fi

    - name: Check README coverage table
      run: |
        echo "" >> doc_report.md
        echo "## README Coverage Table Check" >> doc_report.md

        # Extract data source modules
        MODULES=$(find src/bolster/data_sources -name '*.py' -not -name '__init__.py' -not -name '_base.py')

        echo "Found modules:" >> doc_report.md
        for module in $MODULES; do
          MODULE_NAME=$(basename "$module" .py)

          # Check if mentioned in README
          if grep -q "$MODULE_NAME" README.md; then
            echo "- âœ… $MODULE_NAME - In README" >> doc_report.md
          else
            echo "- âŒ $MODULE_NAME - **Missing from README coverage table**" >> doc_report.md
            echo "README_ISSUES=true" >> $GITHUB_ENV
          fi
        done

    - name: AI-powered documentation review (if available)
      if: env.DOC_ISSUES == 'true' || env.README_ISSUES == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          // This is where we could integrate with GitHub Copilot or other AI
          // to provide intelligent suggestions for missing documentation

          const fs = require('fs');
          const docReport = fs.readFileSync('doc_report.md', 'utf8');

          console.log('Documentation issues detected. AI review could be integrated here.');

          // Example: Generate suggested docstrings for missing functions
          // This could be enhanced with actual AI integration
          const suggestions = `
          ## AI-Generated Documentation Suggestions

          For functions missing docstrings, consider this template:

          \`\`\`python
          def your_function_name(param1: str, param2: int = 10) -> pd.DataFrame:
              """Brief description of what this function does.

              Args:
                  param1: Description of param1
                  param2: Description of param2 with default value

              Returns:
                  DataFrame containing the processed data

              Example:
                  >>> df = your_function_name("example", 5)
                  >>> len(df)
                  100
              """
              pass
          \`\`\`
          `;

          fs.appendFileSync('doc_report.md', suggestions);

    - name: Post PR comment with documentation report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const docReport = fs.readFileSync('doc_report.md', 'utf8');

          // Find existing bot comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Documentation Completeness Report')
          );

          const commentBody = `## ðŸ¤– Documentation Completeness Report

          ${docReport}

          ---
          *This report is automatically generated. Please ensure all public functions have proper docstrings before merging.*`;

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

    - name: Fail if critical documentation missing
      if: env.DOC_ISSUES == 'true' && github.event_name == 'pull_request'
      run: |
        echo "::error::Critical documentation issues found. Please add docstrings to public functions."
        echo "See the PR comment for details on which functions need documentation."
        exit 1

  build-docs:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python and uv
      uses: astral-sh/setup-uv@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: uv sync --group dev --group docs

    - name: Build documentation
      run: |
        cd docs
        uv run sphinx-build -W -b html . _build/html

    - name: Check for broken links in docs
      run: |
        cd docs
        uv run sphinx-build -W -b linkcheck . _build/linkcheck
      continue-on-error: true

    - name: Upload docs artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html/
