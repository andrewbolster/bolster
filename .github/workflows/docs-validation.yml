name: Documentation Validation

on:
  pull_request:
    paths:
    - 'src/bolster/**'
    - 'docs/**'
    - 'README.md'
  push:
    branches: [main]
    paths:
    - 'src/bolster/**'
    - 'docs/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper git diff

    - name: Setup Python and uv
      uses: astral-sh/setup-uv@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: uv sync --dev

    - name: Check for undocumented functions
      id: doc-check
      run: |
        echo "# Documentation Completeness Report" > doc_report.md
        echo "" >> doc_report.md

        # Find all public functions/classes in modified Python files
        echo "## New or Modified Python Functions" >> doc_report.md

        # Get changed Python files
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # Fetch main branch and check diff
          git fetch origin main:main
          CHANGED_FILES=$(git diff --name-only main...HEAD -- '*.py' 'src/**/*.py' 2>/dev/null || find . -name '*.py' -not -path './.*' -not -path './build/*' -not -path './dist/*')
        else
          CHANGED_FILES=$(find . -name '*.py' -not -path './.*' -not -path './build/*' -not -path './dist/*')
        fi

        echo "Checking files: $CHANGED_FILES"

        MISSING_DOCS=()
        GOOD_DOCS=()

        for file in $CHANGED_FILES; do
          if [[ -f "$file" ]]; then
            echo "### $file" >> doc_report.md

            # Extract function definitions
            FUNCTIONS=$(grep -n "^def " "$file" | grep -v "__" | head -10)

            while IFS= read -r line; do
              if [[ -n "$line" ]]; then
                FUNC_NAME=$(echo "$line" | sed 's/.*def \([^(]*\).*/\1/')
                LINE_NUM=$(echo "$line" | cut -d: -f1)

                # Check if function has docstring
                DOCSTRING_CHECK=$(sed -n "${LINE_NUM},/^def \|^class \|^$/p" "$file" | grep -E '^\s*"""' | head -1)

                if [[ -z "$DOCSTRING_CHECK" ]]; then
                  echo "- âŒ \`$FUNC_NAME\` (line $LINE_NUM) - **Missing docstring**" >> doc_report.md
                  MISSING_DOCS+=("$file:$FUNC_NAME")
                else
                  echo "- âœ… \`$FUNC_NAME\` (line $LINE_NUM) - Documented" >> doc_report.md
                  GOOD_DOCS+=("$file:$FUNC_NAME")
                fi
              fi
            done <<< "$FUNCTIONS"

            echo "" >> doc_report.md
          fi
        done

        # Summary
        echo "## Summary" >> doc_report.md
        echo "- âœ… Well documented: ${#GOOD_DOCS[@]} functions" >> doc_report.md
        echo "- âŒ Missing documentation: ${#MISSING_DOCS[@]} functions" >> doc_report.md
        echo "" >> doc_report.md

        if [[ ${#MISSING_DOCS[@]} -gt 0 ]]; then
          echo "## Required Actions" >> doc_report.md
          echo "The following functions need docstrings with Args, Returns, and Example sections:" >> doc_report.md
          for item in "${MISSING_DOCS[@]}"; do
            echo "- $item" >> doc_report.md
          done
          echo "DOC_ISSUES=true" >> $GITHUB_ENV
        else
          echo "DOC_ISSUES=false" >> $GITHUB_ENV
        fi

    - name: Check README mentions for new modules
      run: |
        echo "" >> doc_report.md
        echo "## README Coverage Check" >> doc_report.md

        # Check if any new modules should be mentioned in README
        # This is a simple check - new modules in main source directories should be documented
        NEW_MODULES=$(git diff --name-only main...HEAD -- 'src/**/*.py' 2>/dev/null | grep -E 'src/[^/]+/[^/]+\.py$' | head -5 || echo "")

        if [[ -n "$NEW_MODULES" ]]; then
          echo "New modules detected:" >> doc_report.md
          for module in $NEW_MODULES; do
            MODULE_NAME=$(basename "$module" .py)
            MODULE_PATH=$(dirname "$module")

            # Check if mentioned in README (basic check)
            if grep -qi "$MODULE_NAME\|$(basename "$MODULE_PATH")" README.md; then
              echo "- âœ… $module - Referenced in README" >> doc_report.md
            else
              echo "- âš ï¸ $module - Consider adding to README if this is a new public feature" >> doc_report.md
            fi
          done
        else
          echo "No new modules detected that require README updates." >> doc_report.md
        fi

    - name: GitHub Copilot documentation guidance
      if: env.DOC_ISSUES == 'true'
      run: |
        echo "## ðŸ¤– GitHub Copilot Documentation Guidance" >> doc_report.md
        echo "" >> doc_report.md

        echo "### ðŸ“ Automated Documentation Solutions" >> doc_report.md
        echo "" >> doc_report.md
        echo "**Recommended**: Enable [GitHub Copilot automatic reviews](https://docs.github.com/en/copilot/how-tos/use-copilot-agents/request-a-code-review/configure-automatic-review) for AI-powered documentation feedback." >> doc_report.md
        echo "" >> doc_report.md
        echo "**Setup Options**:" >> doc_report.md
        echo "1. **Repository Rulesets** (Recommended)" >> doc_report.md
        echo "   - Go to Settings â†’ Rules â†’ Rulesets â†’ New branch ruleset" >> doc_report.md
        echo "   - âœ“ Automatically request Copilot code review" >> doc_report.md
        echo "   - âœ“ Review new pushes" >> doc_report.md
        echo "" >> doc_report.md
        echo "2. **User Profile Setting**" >> doc_report.md
        echo "   - Profile â†’ Your Copilot â†’ Automatic code review â†’ Enabled" >> doc_report.md
        echo "" >> doc_report.md
        echo "3. **Custom Instructions**" >> doc_report.md
        echo "   - Add \`.github/copilot-instructions.md\` for project-specific guidance" >> doc_report.md
        echo "   - Run the GitHub Copilot Setup workflow in this repository" >> doc_report.md
        echo "" >> doc_report.md

        # Get changed Python files for specific guidance
        CHANGED_PYTHON_FILES=$(git diff --name-only main...HEAD -- '*.py' 'src/**/*.py' 2>/dev/null | head -3)

        if [[ -n "$CHANGED_PYTHON_FILES" ]]; then
          echo "### ðŸ”§ For This PR" >> doc_report.md
          echo "" >> doc_report.md
          echo "Use GitHub Copilot in your editor to generate docstrings:" >> doc_report.md
          for file in $CHANGED_PYTHON_FILES; do
            if [[ -f "$file" ]]; then
              echo "- **$file**: Place cursor after function definition, type \`\"\"\"\` and accept Copilot suggestions" >> doc_report.md
            fi
          done
          echo "" >> doc_report.md
        fi

        echo "**Benefits of GitHub Native AI**:" >> doc_report.md
        echo "- âœ… No external API keys required" >> doc_report.md
        echo "- âœ… Integrated with GitHub permissions" >> doc_report.md
        echo "- âœ… Automatic vulnerability detection" >> doc_report.md
        echo "- âœ… Real-time suggestions in your editor" >> doc_report.md
        echo "- âœ… No additional cost for most plans" >> doc_report.md

    - name: Post PR comment with documentation report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const docReport = fs.readFileSync('doc_report.md', 'utf8');

          // Find existing bot comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Documentation Completeness Report')
          );

          const commentBody = `## ðŸ¤– Documentation Completeness Report

          ${docReport}

          ---
          *This report is automatically generated. Please ensure all public functions have proper docstrings before merging.*`;

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

    - name: Fail if critical documentation missing
      if: env.DOC_ISSUES == 'true' && github.event_name == 'pull_request'
      run: |
        echo "::error::Critical documentation issues found. Please add docstrings to public functions."
        echo "See the PR comment for details on which functions need documentation."
        exit 1

  build-docs:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python and uv
      uses: astral-sh/setup-uv@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: uv sync --group dev --group docs

    - name: Build documentation
      run: |
        cd docs
        uv run sphinx-build -W -b html . _build/html

    - name: Check for broken links in docs
      run: |
        cd docs
        uv run sphinx-build -W -b linkcheck . _build/linkcheck
      continue-on-error: true

    - name: Upload docs artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html/
