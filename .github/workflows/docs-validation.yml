name: Documentation Validation

on:
  pull_request:
    paths:
    - 'src/bolster/**'
    - 'docs/**'
    - 'README.md'
  push:
    branches: [main]
    paths:
    - 'src/bolster/**'
    - 'docs/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for proper git diff

    - name: Setup Python and uv
      uses: astral-sh/setup-uv@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: uv sync --dev

    - name: Check for undocumented functions
      id: doc-check
      run: |
        echo "# Documentation Completeness Report" > doc_report.md
        echo "" >> doc_report.md

        # Find all public functions/classes in modified Python files
        echo "## New or Modified Python Functions" >> doc_report.md

        # Get changed Python files
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          # Fetch main branch and check diff
          git fetch origin main:main
          CHANGED_FILES=$(git diff --name-only main...HEAD -- '*.py' 'src/**/*.py' 2>/dev/null || find . -name '*.py' -not -path './.*' -not -path './build/*' -not -path './dist/*')
        else
          CHANGED_FILES=$(find . -name '*.py' -not -path './.*' -not -path './build/*' -not -path './dist/*')
        fi

        echo "Checking files: $CHANGED_FILES"

        MISSING_DOCS=()
        GOOD_DOCS=()

        for file in $CHANGED_FILES; do
          if [[ -f "$file" ]]; then
            echo "### $file" >> doc_report.md

            # Extract function definitions
            FUNCTIONS=$(grep -n "^def " "$file" | grep -v "__" | head -10)

            while IFS= read -r line; do
              if [[ -n "$line" ]]; then
                FUNC_NAME=$(echo "$line" | sed 's/.*def \([^(]*\).*/\1/')
                LINE_NUM=$(echo "$line" | cut -d: -f1)

                # Check if function has docstring
                DOCSTRING_CHECK=$(sed -n "${LINE_NUM},/^def \|^class \|^$/p" "$file" | grep -E '^\s*"""' | head -1)

                if [[ -z "$DOCSTRING_CHECK" ]]; then
                  echo "- âŒ \`$FUNC_NAME\` (line $LINE_NUM) - **Missing docstring**" >> doc_report.md
                  MISSING_DOCS+=("$file:$FUNC_NAME")
                else
                  echo "- âœ… \`$FUNC_NAME\` (line $LINE_NUM) - Documented" >> doc_report.md
                  GOOD_DOCS+=("$file:$FUNC_NAME")
                fi
              fi
            done <<< "$FUNCTIONS"

            echo "" >> doc_report.md
          fi
        done

        # Summary
        echo "## Summary" >> doc_report.md
        echo "- âœ… Well documented: ${#GOOD_DOCS[@]} functions" >> doc_report.md
        echo "- âŒ Missing documentation: ${#MISSING_DOCS[@]} functions" >> doc_report.md
        echo "" >> doc_report.md

        if [[ ${#MISSING_DOCS[@]} -gt 0 ]]; then
          echo "## Required Actions" >> doc_report.md
          echo "The following functions need docstrings with Args, Returns, and Example sections:" >> doc_report.md
          for item in "${MISSING_DOCS[@]}"; do
            echo "- $item" >> doc_report.md
          done
          echo "DOC_ISSUES=true" >> $GITHUB_ENV
        else
          echo "DOC_ISSUES=false" >> $GITHUB_ENV
        fi

    - name: Check README mentions for new modules
      run: |
        echo "" >> doc_report.md
        echo "## README Coverage Check" >> doc_report.md

        # Check if any new modules should be mentioned in README
        # This is a simple check - new modules in main source directories should be documented
        NEW_MODULES=$(git diff --name-only main...HEAD -- 'src/**/*.py' 2>/dev/null | grep -E 'src/[^/]+/[^/]+\.py$' | head -5 || echo "")

        if [[ -n "$NEW_MODULES" ]]; then
          echo "New modules detected:" >> doc_report.md
          for module in $NEW_MODULES; do
            MODULE_NAME=$(basename "$module" .py)
            MODULE_PATH=$(dirname "$module")

            # Check if mentioned in README (basic check)
            if grep -qi "$MODULE_NAME\|$(basename "$MODULE_PATH")" README.md; then
              echo "- âœ… $module - Referenced in README" >> doc_report.md
            else
              echo "- âš ï¸ $module - Consider adding to README if this is a new public feature" >> doc_report.md
            fi
          done
        else
          echo "No new modules detected that require README updates." >> doc_report.md
        fi

    - name: AI-powered documentation review
      if: env.DOC_ISSUES == 'true' || env.README_ISSUES == 'true'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      run: |
        echo "## AI-Powered Documentation Review" >> doc_report.md
        echo "" >> doc_report.md

        # Check if AI integration is available
        if [[ -z "$OPENAI_API_KEY" && -z "$ANTHROPIC_API_KEY" ]]; then
          echo "âŒ **AI Review Failed**: No API keys configured" >> doc_report.md
          echo "To enable AI-powered documentation review:" >> doc_report.md
          echo "1. Add OPENAI_API_KEY or ANTHROPIC_API_KEY to repository secrets" >> doc_report.md
          echo "2. The AI will automatically generate docstring suggestions" >> doc_report.md
          echo "" >> doc_report.md
          echo "AI_REVIEW_FAILED=true" >> $GITHUB_ENV
          exit 1
        fi

        # Get the diff for AI analysis
        CHANGED_PYTHON_FILES=$(git diff --name-only main...HEAD -- '*.py' 'src/**/*.py' 2>/dev/null | head -5)

        if [[ -n "$CHANGED_PYTHON_FILES" ]]; then
          echo "Analyzing changed Python files with AI..." >> doc_report.md

          # Generate AI-powered suggestions (using Claude as preference)
          if [[ -n "$ANTHROPIC_API_KEY" ]]; then
            echo "ðŸ¤– Using Claude AI for documentation analysis..." >> doc_report.md

            # Create a focused diff of Python files for analysis
            git diff main...HEAD -- $CHANGED_PYTHON_FILES > python_changes.diff

            # Call Claude API for analysis
            ANALYSIS=$(curl -s -X POST https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d '{
                "model": "claude-3-haiku-20240307",
                "max_tokens": 1000,
                "system": "You are a documentation expert. Analyze the Python code changes and suggest specific docstrings for any functions missing documentation. Focus on Args, Returns, and Example sections. Be concise and practical.",
                "messages": [
                  {
                    "role": "user",
                    "content": "Analyze these Python code changes and suggest docstrings for any functions missing documentation:\n\n'"$(cat python_changes.diff | head -100 | sed 's/"/\\"/g')"'"
                  }
                ]
              }' | jq -r '.content[0].text' 2>/dev/null || echo "AI analysis failed")

            if [[ "$ANALYSIS" != "AI analysis failed" && -n "$ANALYSIS" ]]; then
              echo "### ðŸ¤– Claude AI Suggestions" >> doc_report.md
              echo "" >> doc_report.md
              echo "$ANALYSIS" >> doc_report.md
              echo "" >> doc_report.md
            else
              echo "âŒ Claude AI analysis failed - check API key and quotas" >> doc_report.md
              echo "AI_REVIEW_FAILED=true" >> $GITHUB_ENV
            fi

          elif [[ -n "$OPENAI_API_KEY" ]]; then
            echo "ðŸ¤– Using OpenAI for documentation analysis..." >> doc_report.md
            echo "OpenAI integration not yet implemented - defaulting to failure" >> doc_report.md
            echo "AI_REVIEW_FAILED=true" >> $GITHUB_ENV
          fi
        else
          echo "No Python files changed - AI review not needed" >> doc_report.md
        fi

    - name: Post PR comment with documentation report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const docReport = fs.readFileSync('doc_report.md', 'utf8');

          // Find existing bot comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });

          const botComment = comments.find(comment =>
            comment.user.type === 'Bot' &&
            comment.body.includes('Documentation Completeness Report')
          );

          const commentBody = `## ðŸ¤– Documentation Completeness Report

          ${docReport}

          ---
          *This report is automatically generated. Please ensure all public functions have proper docstrings before merging.*`;

          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

    - name: Fail if critical documentation missing
      if: env.DOC_ISSUES == 'true' && github.event_name == 'pull_request'
      run: |
        echo "::error::Critical documentation issues found. Please add docstrings to public functions."
        echo "See the PR comment for details on which functions need documentation."
        exit 1

  build-docs:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python and uv
      uses: astral-sh/setup-uv@v4
      with:
        python-version: "3.11"

    - name: Install dependencies
      run: uv sync --group dev --group docs

    - name: Build documentation
      run: |
        cd docs
        uv run sphinx-build -W -b html . _build/html

    - name: Check for broken links in docs
      run: |
        cd docs
        uv run sphinx-build -W -b linkcheck . _build/linkcheck
      continue-on-error: true

    - name: Upload docs artifacts
      uses: actions/upload-artifact@v4
      with:
        name: documentation
        path: docs/_build/html/
